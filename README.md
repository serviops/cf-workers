# Cloudflare worker
Example of a Cloudflare Worker using the Serverless framework, with examples of deployment using CircleCI, GitHub Actions and Travis CI.

# Requirements
* npm
* [Cloudflare account](https://www.cloudflare.com/)
* [GitHub account](https://www.github.com/), [Travis CI account](https://travis-ci.org/signup) or [CircleCI account](https://circleci.com/docs/2.0/first-steps/)

# Steps
## Directory structure
A barebone directory structure for a Cloudflare Worker looks like this:
```
.
├── .circleci
│   └── config.yml
├── .github
│   └── workflows
│       └── cloudflare.yml
├── .travis.yml
├── index.js
├── package.json
└── serverless.yml
```

Where:
* `index.js` is the root file for the Cloudflare Worker script
* `package.json` describes the current package and its dependencies
* `serverless.yml`: describes the service to be deployed using the serverless framework and its configuration
* `.circleci/`, `.github/` and `.travis.yml` contain the code necessary to deploy the Cloudflare Worker. Only one of them is necessary

You can also add a `.gitignore` file, which will indicate to git which files and folders to not include in its history. You can use the [Node `.gitinore` template available from GitHub](https://github.com/github/gitignore/blob/master/Node.gitignore).

## Cloudflare worker
In `index.js`, copy the following Hello World example script:

```javascript
addEventListener('fetch', event => {
  event.respondWith(handleEvent(event))
});

async function handleEvent(event) {
  return new Response('Hello cloudflare worker!', { status: 200 })
}
```

## Serverless
Install `serverless` and `serverless-cloudflare-workers` npm packages:
```bash
npm install serverless
npm install serverless-cloudflare-workers
```

In `serverless.yml`, declare your service:
```yaml
service:
  name: cf-workers # name of your Cloudflare Worker
  config:
    accountId: ${env:CLOUDFLARE_ACCOUNT_ID} # The Cloudflare Account ID environment variable will be set with CircleCI, GitHub Actions or Travis CI
    zoneId: ${env:CLOUDFLARE_ZONE_ID} # The Cloudflare Zone ID environment variable will be set with CircleCI, GitHub Actions or Travis CI
```

Declare your serverless cloud provider and its plugin:
```yaml
provider:
  name: cloudflare

plugins:
  - serverless-cloudflare-workers
```

Declare your function:
```yaml
functions:
  cf-workers:
    name: cf-workers # name of the Cloudflare Worker, overrides the name generated by Serverless
    script: index.js # path to your Cloudflare Worker script
```

[A complete example of a `serverless.yml` file can be found here.](serverless.yml)

## CircleCI, GitHub Actions or Travis CI
For a complete documentation on each CI system:

* [CircleCI](doc/circleci.md)
* [GitHub Actions](doc/githubactions.md)
* [Travis CI](doc/travisci.md)
